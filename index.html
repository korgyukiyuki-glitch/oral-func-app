<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="OralFunc">
<title>å£è…”æ©Ÿèƒ½ç™ºé”ä¸å…¨ç—‡ ç®¡ç†ã‚¢ãƒ—ãƒª</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
  * { -webkit-tap-highlight-color: transparent; }
  body { font-family: -apple-system, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif; background: #f0f4f8; }
  input, select, textarea { font-size: 16px !important; }
  @media print {
    body { background: white !important; }
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    .print-page { page-break-after: always; padding: 10mm; }
    .print-page:last-child { page-break-after: auto; }
  }
  .print-only { display: none; }
  .toggle-btn { min-height: 48px; min-width: 48px; }
  .card-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06); }
</style>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: { 50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',300:'#93c5fd',400:'#60a5fa',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8' },
        dental: { 50:'#f0fdf4',100:'#dcfce7',500:'#22c55e',600:'#16a34a',700:'#15803d' }
      }
    }
  }
}
</script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo, useRef } = React;

// ==================== FIREBASE INITIALIZATION ====================
const firebaseConfig = {
  apiKey: "AIzaSyCUeKeTA8WzZZccXZxFAGxRdDLXrh8YLi4",
  authDomain: "oral-func-app.firebaseapp.com",
  projectId: "oral-func-app",
  storageBucket: "oral-func-app.firebasestorage.app",
  messagingSenderId: "851715011859",
  appId: "1:851715011859:web:ef00e15e9310237c32d6e6"
};

let db = null;
let firebaseReady = false;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  firebaseReady = true;
} catch (e) {
  console.warn('Firebase initialization skipped or failed:', e);
  firebaseReady = false;
}

// ==================== DATA ====================
const CHECK_ITEMS = [
  { code:'C1', label:'æ­¯ã®èŒå‡ºã«é…ã‚ŒãŒã‚ã‚‹', category:'chew', type:'clinic', inputType:'toggle' },
  { code:'C2', label:'æ©Ÿèƒ½çš„å› å­ã«ã‚ˆã‚‹æ­¯åˆ—ãƒ»å’¬åˆã®ç•°å¸¸ãŒã‚ã‚‹', category:'chew', type:'clinic', inputType:'toggle' },
  { code:'C3', label:'å’€åš¼ã«å½±éŸ¿ã™ã‚‹ã†è•ãŒã‚ã‚‹ï¼ˆC3ä»¥ä¸Šï¼‰', category:'chew', type:'clinic', inputType:'toggle' },
  { code:'C4', label:'å¼·ãå’¬ã¿ã—ã‚ã‚‰ã‚Œãªã„', category:'chew', type:'clinic', inputType:'toggle' },
  { code:'C5', label:'å’€åš¼å›æ•°ãŒ30å›ä»¥ä¸‹', category:'chew', type:'patient', inputType:'yesno' },
  { code:'C6', label:'ç‰‡å´ã ã‘ã§é£Ÿã¹ã¦ã„ã‚‹', category:'chew', type:'patient', inputType:'yesno' },
  { code:'C8', label:'é£Ÿäº‹ã¯1æ—¥3å›ãƒ»æ±ºã¾ã£ãŸé‡ã‚’é£Ÿã¹ã‚‰ã‚Œã¦ã„ãªã„', category:'eat', type:'patient', inputType:'yesno' },
  { code:'C9', label:'ä¼šè©±æ™‚ã«èãå–ã‚Šã¥ã‚‰ã„', category:'speak', type:'patient', inputType:'yesno' },
  { code:'C7', label:'èˆŒã®çªå‡ºç™–ãŒã‚ã‚‹', category:'other', type:'clinic', inputType:'toggle' },
  { code:'C10', label:'å£ã‚’é–‹ã‘ã¦ã„ã‚‹ãƒ»å£å‘¼å¸ãŒã‚ã‚‹', category:'other', type:'patient', inputType:'yesno' },
  { code:'C11', label:'å£è…”ç¿’ç™–ãŒã‚ã‚‹', category:'other', type:'patient', inputType:'habits' },
  { code:'C12', label:'èˆŒå°å¸¯ã«ç•°å¸¸ãŒã‚ã‚‹', category:'other', type:'clinic', inputType:'toggle' },
  { code:'C15', label:'å£è“‹æ‰æ¡ƒè‚¥å¤§ã‚’èªã‚ã‚‹', category:'other', type:'clinic', inputType:'toggle' },
  { code:'C16', label:'ã„ã³ãã‚’ã‹ã', category:'other', type:'patient', inputType:'yesno' },
  { code:'C13', label:'ã‚„ã›ã€ã¾ãŸã¯è‚¥æº€ã§ã‚ã‚‹', category:'body', type:'patient', inputType:'body' },
];

const HABITS_LIST = [
  'æŒ‡ã—ã‚ƒã¶ã‚Š','å”‡ã‚’å’¬ã‚“ã ã‚Šå¸ã†ç™–','é•·æ™‚é–“ã®é ¬æ–','çˆªã‚’å™›ã‚€',
  'æŠœã‘ãŸå‰æ­¯ã®éš™é–“ã«èˆŒã‚’å…¥ã‚Œã‚‹','èˆŒå…ˆã‚’æ­¯ã®è£å´ã‚„æ­¯ã®éš™é–“ã«æŠ¼ã—ã¤ã‘ã‚‹'
];

const CATEGORY_LABELS = {
  chew: 'é£Ÿã¹ã‚‹æ©Ÿèƒ½ï¼ˆå’€åš¼ï¼‰',
  eat: 'é£Ÿã¹ã‚‹æ©Ÿèƒ½ï¼ˆé£Ÿè¡Œå‹•ï¼‰',
  speak: 'è©±ã™æ©Ÿèƒ½',
  other: 'å‘¼å¸ãƒ»ãã®ä»–ã®æ©Ÿèƒ½',
  body: 'å…¨èº«çŠ¶æ…‹'
};

const PLAN_TEMPLATES = {
  C1:  { problem:'æ­¯ã®ç”Ÿãˆå¤‰ã‚ã‚ŠãŒé…ã‚Œã¦ãŠã‚Šã€å™›ã‚€åŠ›ã®ç™ºé”ã‚„ã‚ã”ã®æˆé•·ã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', shortTerm:'3ã€œ6ã‹æœˆã”ã¨ã«æ­¯ã®ç”Ÿãˆå…·åˆã¨ãƒ¬ãƒ³ãƒˆã‚²ãƒ³ã§çµŒéã‚’ç¢ºèªã—ã¾ã™ã€‚', longTerm:'æ°¸ä¹…æ­¯ã®ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†ã¨ã‚ã”ã®æˆé•·ç¢ºèªã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦çŸ¯æ­£ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚' },
  C2:  { problem:'å£å‘¼å¸ã‚„èˆŒã®ç™–ã«ã‚ˆã‚Šã€æ­¯ä¸¦ã³ãƒ»ã‹ã¿åˆã‚ã›ãŒä¹±ã‚Œã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚', shortTerm:'ãã¡ã³ã‚‹ãƒ»èˆŒã®åŠ›ã‚’æ¸¬å®šã—ã€ãŠå£ã®ç­‹è‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆMFTï¼‰ã¨é¼»å‘¼å¸ã®ç·´ç¿’ã‚’å§‹ã‚ã¾ã™ã€‚', longTerm:'æ©Ÿèƒ½æ”¹å–„å¾Œã«çŸ¯æ­£æ²»ç™‚ã®å¿…è¦æ€§ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚' },
  C3:  { problem:'ã‚€ã—æ­¯ã®ç—›ã¿ã«ã‚ˆã‚Šã€ç‰‡å´ã ã‘ã§å™›ã‚€ç™–ãŒã¤ãã‚„ã™ã„çŠ¶æ…‹ã§ã™ã€‚', shortTerm:'ã‚€ã—æ­¯ã®æ²»ç™‚ã‚’å„ªå…ˆã—ã€ç—›ã¿ã‚’å–ã‚Šé™¤ãã¾ã™ã€‚', longTerm:'å™›ã‚€ç·´ç¿’ã¨ãƒ•ãƒƒç´ ã‚’æ´»ç”¨ã—ãŸã‚€ã—æ­¯äºˆé˜²ã‚’ç¶šã‘ã¾ã™ã€‚' },
  C4:  { problem:'å™›ã‚€åŠ›ãŒå¼±ãã€ã‚ã”ã®ç™ºé”ãŒååˆ†ã«é€²ã¿ã«ãã„çŠ¶æ…‹ã§ã™ã€‚', shortTerm:'ã‚„ã‚ã‚‰ã‹ã„ã‚‚ã®ã‹ã‚‰æ®µéšçš„ã«ç¡¬ã•ã‚’ä¸Šã’ã‚‹å™›ã‚€ç·´ç¿’ã‚’è¡Œã„ã¾ã™ã€‚', longTerm:'ã‹ã¿åˆã‚ã›ã®èª¿æ•´ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦çŸ¯æ­£æ²»ç™‚ã¨é€£æºã—ã¾ã™ã€‚' },
  C5:  { problem:'å™›ã‚€å›æ•°ãŒå°‘ãªãã€ã‚ã”ã®æˆé•·ã‚„é£Ÿã¹ç‰©ã‚’ã¾ã¨ã‚ã‚‹åŠ›ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', shortTerm:'ä¸€å£30å›å™›ã‚€ã“ã¨ã‚’ç›®æ¨™ã«ã€ã”å®¶åº­ã§ã®é£Ÿäº‹ã®å·¥å¤«ã‚‚æŒ‡å°ã—ã¾ã™ã€‚', longTerm:'é£Ÿäº‹ã®ç¡¬ã•ãƒ»å¤§ãã•ã‚’è¦‹ç›´ã—ã€3ã‹æœˆã”ã¨ã«å†è©•ä¾¡ã—ã¾ã™ã€‚' },
  C6:  { problem:'ç‰‡å´ã ã‘ã§å™›ã‚€ç™–ãŒã‚ã‚Šã€ã‚ã”ã®ãšã‚Œã‚„é¡”ã®å·¦å³å·®ã«ã¤ãªãŒã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚', shortTerm:'å·¦å³ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå™›ã‚€ç·´ç¿’ã¨ã€ã‹ã¿åˆã‚ã›ã®ç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚', longTerm:'æ©Ÿèƒ½è¨“ç·´ã‚’ç¶™ç¶šã—ã€å¿…è¦ã«å¿œã˜ã¦çŸ¯æ­£ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚' },
  C7:  { problem:'èˆŒã®è£ã®ã™ã˜ãŒçŸ­ãã€èˆŒã®å‹•ããŒåˆ¶é™ã•ã‚Œç™ºéŸ³ã«å½±éŸ¿ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚', shortTerm:'èˆŒã‚’å‹•ã‹ã™ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚', longTerm:'æ”¹å–„ãŒä¸ååˆ†ãªå ´åˆã€åˆ‡é™¤æ‰‹è¡“ã‚’æ¤œè¨ã—ã¾ã™ã€‚' },
  C8:  { problem:'é–“é£Ÿã®å›æ•°ãŒå¤šãã€ã‚€ã—æ­¯ã«ãªã‚Šã‚„ã™ã„çŠ¶æ…‹ã§ã™ã€‚', plan:'ãŠã‚„ã¤ã®å›æ•°ãƒ»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»é£²ã¿ç‰©ã®é¸ã³æ–¹ã‚’æŒ‡å°ã—ã¾ã™ã€‚' },
  C9:  { problem:'èˆŒã®æ©Ÿèƒ½ä¸è¶³ã«ã‚ˆã‚Šã€ç™ºéŸ³ãŒä¸æ˜ç­ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', plan:'èˆŒã®åŠ›ã®æ¤œæŸ»ã¨ãŠå£ã®ç­‹è‚‰ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆMFTï¼‰ã‚’è¡Œã„ã¾ã™ã€‚' },
  C10: { problem:'å£å‘¼å¸ã«ã‚ˆã‚Šæ­¯åˆ—ãŒç‹­ããªã‚Šã€ä¸Šã‚ã”ã®æˆé•·ãŒä¸ååˆ†ã«ãªã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚', shortTerm:'é¼»å‘¼å¸ã®ç·´ç¿’ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦è€³é¼»ç§‘å—è¨ºã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚', longTerm:'ä¸Šã‚ã”ã‚’åºƒã’ã‚‹è£…ç½®ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚' },
  C11: { problem:'æŒ‡ã—ã‚ƒã¶ã‚Šç­‰ã®ç™–ãŒæ­¯ä¸¦ã³ã‚’ä¹±ã™åŸå› ã«ãªã£ã¦ã„ã¾ã™ã€‚', plan:'ç™–ã‚’ãªãã™æŒ‡å°ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¡¨ã‚’ãŠæ¸¡ã—ã—ã€ã”å®¶åº­ã¨é€£æºã—ã¦æ”¹å–„ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚' },
  C12: { problem:'èˆŒã®è£ã®ã™ã˜ã«ç•°å¸¸ãŒã‚ã‚Šã€èˆŒã®æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚', shortTerm:'èˆŒã®æ©Ÿèƒ½ã‚’è©•ä¾¡ã—ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚', longTerm:'æ”¹å–„ä¸ååˆ†ãªå ´åˆã¯å¤–ç§‘çš„å‡¦ç½®ã‚’æ¤œè¨ã—ã¾ã™ã€‚' },
  C13: { problem:'ä½“æ ¼ãŒæ¨™æº–ç¯„å›²ã‹ã‚‰å¤–ã‚Œã¦ãŠã‚Šã€å…¨èº«ã®ç™ºè‚²ã‚„ãŠå£ã®æ©Ÿèƒ½ã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', plan:'ä½“æ ¼æŒ‡æ•°ã‚’ç®—å‡ºã—ã€é£Ÿäº‹ã®è¦‹ç›´ã—ã‚’æŒ‡å°ã—ã¾ã™ã€‚' },
  C15: { problem:'æ‰æ¡ƒè…ºãŒå¤§ããã€å£å‘¼å¸ã‚„ç¡çœ ä¸­ã®å‘¼å¸éšœå®³ã®åŸå› ã¨ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', plan:'è€³é¼»ç§‘ã¸ã®å—è¨ºã‚’ãŠã™ã™ã‚ã—ã€ç¡çœ æ™‚ç„¡å‘¼å¸ã®è©•ä¾¡ã‚’è¡Œã„ã¾ã™ã€‚' },
  C16: { problem:'ç¡çœ ã®è³ªãŒä½ä¸‹ã—ã€ã‚ã”ã®ç™ºè‚²ã«å½±éŸ¿ã™ã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™ã€‚', plan:'ç¡çœ çŠ¶æ…‹ã®è©•ä¾¡ã¨å£å‘¼å¸ã®æ”¹å–„ã‚’è¡Œã„ã€å¿…è¦ã«å¿œã˜ã¦å‘¼å¸ã®æ”¹å–„ã«ã¤ãªãŒã‚‹ä¸Šã‚ã”ã‚’åºƒã’ã‚‹è£…ç½®ã‚’ã”ææ¡ˆã—ã¾ã™ã€‚' },
};

// ==================== UTILITIES ====================
function generateId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

function calcAge(birthDate) {
  if (!birthDate) return null;
  const today = new Date();
  const birth = new Date(birthDate);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

function calcAgeMonths(birthDate) {
  if (!birthDate) return null;
  const today = new Date();
  const birth = new Date(birthDate);
  return (today.getFullYear() - birth.getFullYear()) * 12 + (today.getMonth() - birth.getMonth());
}

function calcKaup(weightKg, heightCm) {
  if (!weightKg || !heightCm) return null;
  return ((weightKg * 10000) / (heightCm * heightCm)).toFixed(1);
}

function calcRohrer(weightKg, heightCm) {
  if (!weightKg || !heightCm) return null;
  return ((weightKg * 10000000) / (heightCm * heightCm * heightCm)).toFixed(1);
}

function getBodyStatus(index, isKaup) {
  if (!index) return 'unknown';
  const v = parseFloat(index);
  if (isKaup) {
    if (v < 15) return 'underweight';
    if (v > 18) return 'overweight';
    return 'normal';
  } else {
    if (v < 115) return 'underweight';
    if (v > 145) return 'overweight';
    return 'normal';
  }
}

function formatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  return `${dt.getFullYear()}/${(dt.getMonth()+1).toString().padStart(2,'0')}/${dt.getDate().toString().padStart(2,'0')}`;
}

// ==================== CRYPTO ====================
const SALT_KEY = 'oralFuncSalt';
const DATA_KEY = 'oralFuncDataEnc';
const PIN_CHECK_KEY = 'oralFuncPinCheck';

async function deriveCryptoKey(pin, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(pin), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt', 'decrypt']
  );
}

async function encryptData(data, pin) {
  let salt = localStorage.getItem(SALT_KEY);
  if (!salt) { const s = crypto.getRandomValues(new Uint8Array(16)); salt = btoa(String.fromCharCode(...s)); localStorage.setItem(SALT_KEY, salt); }
  const saltBytes = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
  const key = await deriveCryptoKey(pin, saltBytes);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode(JSON.stringify(data)));
  const combined = new Uint8Array(iv.length + encrypted.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(encrypted), iv.length);
  localStorage.setItem(DATA_KEY, btoa(String.fromCharCode(...combined)));
}

async function decryptData(pin) {
  const stored = localStorage.getItem(DATA_KEY);
  if (!stored) return { patients: [], assessments: [] };
  const saltStr = localStorage.getItem(SALT_KEY);
  if (!saltStr) throw new Error('No salt');
  const saltBytes = Uint8Array.from(atob(saltStr), c => c.charCodeAt(0));
  const key = await deriveCryptoKey(pin, saltBytes);
  const combined = Uint8Array.from(atob(stored), c => c.charCodeAt(0));
  const iv = combined.slice(0, 12);
  const ciphertext = combined.slice(12);
  const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
  return JSON.parse(new TextDecoder().decode(decrypted));
}

async function savePinCheck(pin) {
  let salt = localStorage.getItem(SALT_KEY);
  if (!salt) { const s = crypto.getRandomValues(new Uint8Array(16)); salt = btoa(String.fromCharCode(...s)); localStorage.setItem(SALT_KEY, salt); }
  const saltBytes = Uint8Array.from(atob(salt), c => c.charCodeAt(0));
  const key = await deriveCryptoKey(pin, saltBytes);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const enc = new TextEncoder();
  const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, enc.encode('OK'));
  const combined = new Uint8Array(iv.length + encrypted.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(encrypted), iv.length);
  localStorage.setItem(PIN_CHECK_KEY, btoa(String.fromCharCode(...combined)));
}

async function verifyPin(pin) {
  const stored = localStorage.getItem(PIN_CHECK_KEY);
  if (!stored) return false;
  try {
    const saltStr = localStorage.getItem(SALT_KEY);
    const saltBytes = Uint8Array.from(atob(saltStr), c => c.charCodeAt(0));
    const key = await deriveCryptoKey(pin, saltBytes);
    const combined = Uint8Array.from(atob(stored), c => c.charCodeAt(0));
    const iv = combined.slice(0, 12);
    const ciphertext = combined.slice(12);
    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
    return true;
  } catch { return false; }
}

function isFirstRun() { return !localStorage.getItem(PIN_CHECK_KEY); }

// ==================== FIRESTORE SYNC ====================
// Save a single patient to Firestore
async function savePatientToFirestore(patient) {
  if (!firebaseReady || !db) return;
  try {
    await db.collection('patients').doc(patient.id).set(patient, { merge: true });
  } catch (e) {
    console.warn('Error saving patient to Firestore:', e);
  }
}

// Save a single assessment to Firestore
async function saveAssessmentToFirestore(assessment) {
  if (!firebaseReady || !db) return;
  try {
    await db.collection('assessments').doc(assessment.id).set(assessment, { merge: true });
  } catch (e) {
    console.warn('Error saving assessment to Firestore:', e);
  }
}

// Delete patient from Firestore
async function deletePatientFromFirestore(patientId) {
  if (!firebaseReady || !db) return;
  try {
    await db.collection('patients').doc(patientId).delete();
  } catch (e) {
    console.warn('Error deleting patient from Firestore:', e);
  }
}

// Load all data from Firestore
async function loadDataFromFirestore() {
  if (!firebaseReady || !db) return null;
  try {
    const patientsSnap = await db.collection('patients').get();
    const assessmentsSnap = await db.collection('assessments').get();
    const patients = [];
    const assessments = [];
    patientsSnap.forEach(doc => patients.push(doc.data()));
    assessmentsSnap.forEach(doc => assessments.push(doc.data()));
    return { patients, assessments };
  } catch (e) {
    console.warn('Error loading data from Firestore:', e);
    return null;
  }
}

// ==================== PIN SCREEN ====================
function PinScreen({ onAuth }) {
  const first = isFirstRun();
  const [pin, setPin] = useState('');
  const [confirmPin, setConfirmPin] = useState('');
  const [step, setStep] = useState(first ? 'setup' : 'login');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSetup = async () => {
    if (pin.length < 4) { setError('4æ¡ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    if (step === 'setup') { setStep('confirm'); setConfirmPin(''); setError(''); return; }
    if (pin !== confirmPin) { setError('PINãŒä¸€è‡´ã—ã¾ã›ã‚“'); setConfirmPin(''); return; }
    setLoading(true);
    await savePinCheck(pin);
    await encryptData({ patients: [], assessments: [] }, pin);
    onAuth(pin);
  };

  const handleLogin = async () => {
    if (!pin) return;
    setLoading(true);
    const ok = await verifyPin(pin);
    if (ok) { onAuth(pin); }
    else { setError('PINãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); setPin(''); setLoading(false); }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-blue-50 to-white flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl card-shadow p-8 w-full max-w-sm text-center">
        <div className="text-4xl mb-4">ğŸ¦·</div>
        <h1 className="text-lg font-bold text-gray-800 mb-1">å£è…”æ©Ÿèƒ½ç™ºé”ä¸å…¨ç—‡</h1>
        <h2 className="text-sm text-gray-500 mb-6">ç®¡ç†ã‚¢ãƒ—ãƒª</h2>
        {step === 'setup' && (
          <>
            <p className="text-sm text-gray-600 mb-4">åˆæœŸè¨­å®šï¼šPINã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
            <input type="password" inputMode="numeric" pattern="[0-9]*" maxLength={8}
              value={pin} onChange={e=>{ setPin(e.target.value.replace(/\D/g,'')); setError(''); }}
              className="w-full text-center text-2xl tracking-[0.5em] px-4 py-4 bg-gray-50 border border-gray-200 rounded-2xl mb-3"
              placeholder="PIN" autoFocus/>
            {error && <p className="text-red-500 text-sm mb-3">{error}</p>}
            <button onClick={handleSetup} disabled={loading || pin.length<4}
              className="w-full py-4 bg-primary-600 text-white rounded-2xl font-bold text-base disabled:opacity-40">
              æ¬¡ã¸
            </button>
          </>
        )}
        {step === 'confirm' && (
          <>
            <p className="text-sm text-gray-600 mb-4">ç¢ºèªï¼šåŒã˜PINã‚’ã‚‚ã†ä¸€åº¦å…¥åŠ›</p>
            <input type="password" inputMode="numeric" pattern="[0-9]*" maxLength={8}
              value={confirmPin} onChange={e=>{ setConfirmPin(e.target.value.replace(/\D/g,'')); setError(''); }}
              className="w-full text-center text-2xl tracking-[0.5em] px-4 py-4 bg-gray-50 border border-gray-200 rounded-2xl mb-3"
              placeholder="PINç¢ºèª" autoFocus/>
            {error && <p className="text-red-500 text-sm mb-3">{error}</p>}
            <button onClick={handleSetup} disabled={loading || confirmPin.length<4}
              className="w-full py-4 bg-primary-600 text-white rounded-2xl font-bold text-base disabled:opacity-40">
              {loading ? 'è¨­å®šä¸­...' : 'è¨­å®šå®Œäº†'}
            </button>
          </>
        )}
        {step === 'login' && (
          <>
            <p className="text-sm text-gray-600 mb-4">PINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <input type="password" inputMode="numeric" pattern="[0-9]*" maxLength={8}
              value={pin} onChange={e=>{ setPin(e.target.value.replace(/\D/g,'')); setError(''); }}
              className="w-full text-center text-2xl tracking-[0.5em] px-4 py-4 bg-gray-50 border border-gray-200 rounded-2xl mb-3"
              placeholder="PIN" autoFocus/>
            {error && <p className="text-red-500 text-sm mb-3">{error}</p>}
            <button onClick={handleLogin} disabled={loading || !pin}
              className="w-full py-4 bg-primary-600 text-white rounded-2xl font-bold text-base disabled:opacity-40">
              {loading ? 'èªè¨¼ä¸­...' : 'ãƒ­ã‚°ã‚¤ãƒ³'}
            </button>
          </>
        )}
      </div>
    </div>
  );
}

// legacy migration: move unencrypted data
function getLegacyData() {
  try { const d = localStorage.getItem('oralFuncData'); if(d) return JSON.parse(d); } catch{}
  return null;
}

// ==================== DATA (encrypted) ====================
function loadData() { return { patients: [], assessments: [] }; }
function saveData() { /* no-op: saving handled by App via encryptData */ }

// ==================== COMPONENTS ====================

// --- Field (å¤–éƒ¨å®šç¾©ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç¶­æŒ) ---
function Field({ label, children, half }) {
  return (
    <div className={half ? 'w-1/2' : 'w-full'}>
      <label className="block text-xs font-medium text-gray-500 mb-1">{label}</label>
      {children}
    </div>
  );
}
const inputCls = "w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl text-base";

// --- Header ---
function Header({ title, onBack, rightAction }) {
  return (
    <div className="no-print bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-50">
      <div className="flex items-center gap-3">
        {onBack && (
          <button onClick={onBack} className="toggle-btn flex items-center text-primary-600 font-medium">
            <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7"/></svg>
            æˆ»ã‚‹
          </button>
        )}
        <h1 className="text-lg font-bold text-gray-800">{title}</h1>
      </div>
      {rightAction}
    </div>
  );
}

// --- Patient List ---
function PatientList({ patients, assessments, onSelect, onAdd }) {
  const [search, setSearch] = useState('');
  const filtered = patients.filter(p => p.name.includes(search) || (p.patientId||'').includes(search));

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title="å£è…”æ©Ÿèƒ½ç™ºé”ä¸å…¨ç—‡ ç®¡ç†ã‚¢ãƒ—ãƒª" rightAction={
        <button onClick={onAdd} className="toggle-btn bg-primary-600 text-white px-4 py-2 rounded-xl font-medium text-sm">ï¼‹ æ–°è¦æ‚£è€…</button>
      }/>
      <div className="p-4 max-w-2xl mx-auto">
        <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="æ‚£è€…åãƒ»IDã§æ¤œç´¢..."
          className="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-base mb-4"/>
        {filtered.length === 0 ? (
          <div className="text-center py-16 text-gray-400">
            <svg className="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <p className="text-lg font-medium mb-2">æ‚£è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p className="text-sm">ã€Œï¼‹ æ–°è¦æ‚£è€…ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„</p>
          </div>
        ) : filtered.map(p => {
          const age = calcAge(p.birthDate);
          const asmts = assessments.filter(a => a.patientId === p.id);
          const lastAsmt = asmts.length > 0 ? asmts[asmts.length-1] : null;
          const checkedCount = lastAsmt ? Object.entries(lastAsmt.checks).filter(([k,v]) => {
            if (k === 'C11') return v && v.length > 0;
            if (k === 'C13') return v === 'underweight' || v === 'overweight';
            return v === true;
          }).length : 0;
          return (
            <button key={p.id} onClick={()=>onSelect(p)} className="w-full text-left bg-white rounded-2xl p-4 mb-3 card-shadow active:bg-gray-50 transition">
              <div className="flex justify-between items-start">
                <div>
                  <div className="font-bold text-gray-800 text-base">{p.name}</div>
                  <div className="text-sm text-gray-500 mt-1">{age !== null ? `${age}æ­³` : ''} {p.sex === 'M' ? 'ç”·å…' : p.sex === 'F' ? 'å¥³å…' : ''}</div>
                </div>
                <div className="text-right">
                  {lastAsmt && <span className="inline-block bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded-lg">è©²å½“ {checkedCount}é …ç›®</span>}
                </div>
              </div>
              {lastAsmt && <div className="text-xs text-gray-400 mt-2">æœ€çµ‚è©•ä¾¡: {formatDate(lastAsmt.date)}</div>}
            </button>
          );
        })}
      </div>
    </div>
  );
}

// --- Patient Form ---
function PatientForm({ patient, onSave, onCancel }) {
  const initPatient = patient || {
    id: generateId(), patientId:'', name:'', birthDate:'', sex:'', weight:'', height:'',
    guardianName:'', contact:'', doctor:'', firstVisitDate: new Date().toISOString().split('T')[0]
  };
  if(initPatient.birthDate && !initPatient.birthDateRaw) { initPatient.birthDateRaw = initPatient.birthDate.replace(/-/g,''); }
  const [form, setForm] = useState(initPatient);
  const set = (k,v) => setForm(prev => ({...prev, [k]:v}));
  const age = calcAge(form.birthDate);
  const isKaup = age !== null && age < 6;
  const idx = isKaup ? calcKaup(parseFloat(form.weight), parseFloat(form.height)) : calcRohrer(parseFloat(form.weight), parseFloat(form.height));

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title={patient ? "æ‚£è€…æƒ…å ± ç·¨é›†" : "æ–°è¦æ‚£è€… ç™»éŒ²"} onBack={onCancel} rightAction={
        <button onClick={()=>onSave(form)} className="toggle-btn bg-primary-600 text-white px-5 py-2 rounded-xl font-medium text-sm">ä¿å­˜</button>
      }/>
      <div className="p-4 max-w-2xl mx-auto space-y-4">
        <div className="bg-white rounded-2xl p-4 card-shadow space-y-3">
          <h2 className="font-bold text-gray-700 text-sm border-b pb-2">åŸºæœ¬æƒ…å ±</h2>
          <div className="flex gap-3">
            <Field label="æ‚£è€…ID" half><input value={form.patientId} onChange={e=>set('patientId',e.target.value)} className={inputCls} placeholder="ä»»æ„"/></Field>
            <Field label="æ°å *" half><input value={form.name} onChange={e=>set('name',e.target.value)} className={inputCls} placeholder="å±±ç”° å¤ªéƒ"/></Field>
          </div>
          <div className="flex gap-3">
            <Field label="ç”Ÿå¹´æœˆæ—¥ *ï¼ˆ8æ¡: 20180315ï¼‰" half><input type="text" inputMode="numeric" maxLength={8} placeholder="20180315" value={form.birthDateRaw || ''} onChange={e=>{
              const v = e.target.value.replace(/\D/g,'').slice(0,8);
              set('birthDateRaw', v);
              if(v.length===8){
                const formatted = v.slice(0,4)+'-'+v.slice(4,6)+'-'+v.slice(6,8);
                const d = new Date(formatted);
                if(!isNaN(d.getTime())) set('birthDate', formatted);
              } else { set('birthDate',''); }
            }} className={inputCls}/>{form.birthDate && <div className="text-xs text-gray-500 mt-1">{form.birthDate}</div>}</Field>
            <Field label="æ€§åˆ¥" half>
              <div className="flex gap-2">
                {[['M','ç”·'],['F','å¥³']].map(([v,l])=>(
                  <button key={v} onClick={()=>set('sex',v)} className={`flex-1 py-3 rounded-xl text-sm font-medium border transition ${form.sex===v?'bg-primary-600 text-white border-primary-600':'bg-gray-50 text-gray-600 border-gray-200'}`}>{l}</button>
                ))}
              </div>
            </Field>
          </div>
          {age !== null && <div className="text-sm text-primary-600 font-medium bg-primary-50 rounded-lg px-3 py-2">å¹´é½¢: {age}æ­³ï¼ˆ{calcAgeMonths(form.birthDate)}ã‹æœˆï¼‰</div>}
          <div className="flex gap-3">
            <Field label="ä½“é‡ (kg)" half><input type="number" step="0.1" value={form.weight} onChange={e=>set('weight',e.target.value)} className={inputCls}/></Field>
            <Field label="èº«é•· (cm)" half><input type="number" step="0.1" value={form.height} onChange={e=>set('height',e.target.value)} className={inputCls}/></Field>
          </div>
          {idx && (
            <div className={`text-sm font-medium rounded-lg px-3 py-2 ${getBodyStatus(idx,isKaup)==='normal'?'bg-green-50 text-green-700':getBodyStatus(idx,isKaup)==='underweight'?'bg-yellow-50 text-yellow-700':'bg-red-50 text-red-700'}`}>
              {isKaup ? 'ã‚«ã‚¦ãƒ—æŒ‡æ•°' : 'ãƒ­ãƒ¼ãƒ¬ãƒ«æŒ‡æ•°'}: {idx}
              {getBodyStatus(idx,isKaup)==='normal'?' ï¼ˆæ­£å¸¸ï¼‰':getBodyStatus(idx,isKaup)==='underweight'?' ï¼ˆã‚„ã›å‚¾å‘ï¼‰':' ï¼ˆè‚¥æº€å‚¾å‘ï¼‰'}
            </div>
          )}
        </div>
        <div className="bg-white rounded-2xl p-4 card-shadow space-y-3">
          <h2 className="font-bold text-gray-700 text-sm border-b pb-2">ä¿è­·è€…ãƒ»æ‹…å½“</h2>
          <Field label="ä¿è­·è€…æ°å"><input value={form.guardianName} onChange={e=>set('guardianName',e.target.value)} className={inputCls}/></Field>
          <Field label="é€£çµ¡å…ˆ"><input value={form.contact} onChange={e=>set('contact',e.target.value)} className={inputCls} placeholder="é›»è©±ç•ªå·"/></Field>
          <div className="flex gap-3">
            <Field label="æ‹…å½“åŒ»" half><input value={form.doctor} onChange={e=>set('doctor',e.target.value)} className={inputCls}/></Field>
            <Field label="åˆè¨ºæ—¥" half><input type="date" value={form.firstVisitDate} onChange={e=>set('firstVisitDate',e.target.value)} className={inputCls}/></Field>
          </div>
        </div>
      </div>
    </div>
  );
}

// --- Assessment Checklist ---
function AssessmentForm({ patient, existingAssessment, onSave, onCancel }) {
  const age = calcAge(patient.birthDate);
  const isKaup = age !== null && age < 6;
  const idx = isKaup ? calcKaup(parseFloat(patient.weight), parseFloat(patient.height)) : calcRohrer(parseFloat(patient.weight), parseFloat(patient.height));
  const bodyStatus = getBodyStatus(idx, isKaup);

  const [checks, setChecks] = useState(existingAssessment?.checks || {
    C1:false,C2:false,C3:false,C4:false,C5:false,C6:false,C7:false,C8:false,
    C9:false,C10:false,C11:[],C12:false,C13:bodyStatus,C13_patient:null,C15:false,C16:false
  });
  const [lipForce, setLipForce] = useState(existingAssessment?.lipForce || '');
  const [tonguePressure, setTonguePressure] = useState(existingAssessment?.tonguePressure || '');
  const [patientMode, setPatientMode] = useState(false);
  const [holdProgress, setHoldProgress] = useState(0);
  const holdTimerRef = useRef(null);
  const holdStartRef = useRef(null);
  const HOLD_DURATION = 2000;

  const handleModeToggle = () => {}; // é•·æŠ¼ã—ã®ã¿ã§åˆ‡ã‚Šæ›¿ãˆ
  const handleHoldStart = () => {
    holdStartRef.current = Date.now();
    const targetMode = !patientMode;
    const animate = () => {
      const elapsed = Date.now() - holdStartRef.current;
      const progress = Math.min(elapsed / HOLD_DURATION, 1);
      setHoldProgress(progress);
      if (progress >= 1) { setPatientMode(targetMode); setHoldProgress(0); return; }
      holdTimerRef.current = requestAnimationFrame(animate);
    };
    holdTimerRef.current = requestAnimationFrame(animate);
  };
  const handleHoldEnd = () => {
    if (holdTimerRef.current) { cancelAnimationFrame(holdTimerRef.current); holdTimerRef.current = null; }
    setHoldProgress(0);
  };

  const toggle = (code) => setChecks(prev => ({...prev, [code]: !prev[code]}));
  const toggleHabit = (habit) => {
    setChecks(prev => {
      const cur = prev.C11 || [];
      return {...prev, C11: cur.includes(habit) ? cur.filter(h=>h!==habit) : [...cur, habit]};
    });
  };

  useEffect(() => { setChecks(prev => ({...prev, C13: bodyStatus})); }, [bodyStatus]);

  const handleSave = () => {
    onSave({
      id: existingAssessment?.id || generateId(),
      patientId: patient.id,
      date: new Date().toISOString().split('T')[0],
      checks, lipForce, tonguePressure,
      plans: {}
    });
  };

  const categories = ['chew','eat','speak','other','body'];
  const filteredItems = patientMode ? CHECK_ITEMS.filter(i => i.type === 'patient') : CHECK_ITEMS;

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title={patientMode ? "å•è¨ºï¼ˆæ‚£è€…ã•ã¾ç”¨ï¼‰" : "å£è…”æ©Ÿèƒ½è©•ä¾¡ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ"} onBack={onCancel} rightAction={
        <div className="flex gap-2">
          <button
            onClick={handleModeToggle}
            onTouchStart={handleHoldStart} onTouchEnd={handleHoldEnd} onTouchCancel={handleHoldEnd}
            onMouseDown={handleHoldStart} onMouseUp={handleHoldEnd} onMouseLeave={handleHoldEnd}
            className={`toggle-btn px-3 py-2 rounded-xl text-xs font-medium border relative overflow-hidden select-none ${patientMode?'bg-dental-500 text-white border-dental-500':'bg-orange-500 text-white border-orange-500'}`}
            style={{WebkitUserSelect:'none',userSelect:'none'}}
          >
            {holdProgress > 0 && (
              <div className={`absolute inset-0 ${patientMode ? 'bg-blue-400' : 'bg-yellow-300'} opacity-40`} style={{width:`${holdProgress*100}%`,transition:'none'}}/>
            )}
            <span className="relative z-10">{holdProgress > 0 ? `åˆ‡æ›¿ä¸­... ${Math.round(holdProgress*100)}%` : (patientMode ? 'åŒ»é™¢ãƒ¢ãƒ¼ãƒ‰ã¸' : 'æ‚£è€…ãƒ¢ãƒ¼ãƒ‰ã¸')}</span>
          </button>
          <button onClick={handleSave} className="toggle-btn bg-primary-600 text-white px-4 py-2 rounded-xl font-medium text-sm">æ¬¡ã¸ â†’</button>
        </div>
      }/>
      <div className="p-4 max-w-2xl mx-auto">
        <div className="bg-blue-50 rounded-xl p-3 mb-4 text-sm text-blue-700">
          <span className="font-bold">{patient.name}</span>ï¼ˆ{age}æ­³ï¼‰ã®è©•ä¾¡
        </div>

        {categories.map(cat => {
          const items = filteredItems.filter(i => i.category === cat);
          if (items.length === 0) return null;
          return (
            <div key={cat} className="mb-4">
              <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-1">{CATEGORY_LABELS[cat]}</h3>
              <div className="bg-white rounded-2xl card-shadow overflow-hidden">
                {items.map((item, i) => (
                  <div key={item.code} className={`p-4 ${i > 0 ? 'border-t border-gray-100' : ''}`}>
                    <div className="flex items-center justify-between gap-3">
                      <div className="flex-1">
                        <span className="inline-block bg-gray-100 text-gray-600 text-xs font-bold px-2 py-0.5 rounded mr-2">{item.code}</span>
                        <span className={`text-sm ${patientMode ? 'text-base' : ''}`}>{item.label}</span>
                        {item.type === 'clinic' && !patientMode && <span className="text-xs text-blue-500 ml-2">åŒ»é™¢</span>}
                        {item.type === 'patient' && !patientMode && <span className="text-xs text-green-500 ml-2">æ‚£è€…</span>}
                      </div>
                      {item.inputType === 'toggle' && (
                        <button onClick={()=>toggle(item.code)} className={`toggle-btn px-4 py-2 rounded-xl text-sm font-medium transition ${checks[item.code]?'bg-red-500 text-white':'bg-gray-100 text-gray-500'}`}>
                          {checks[item.code] ? 'è©²å½“' : 'éè©²å½“'}
                        </button>
                      )}
                      {item.inputType === 'yesno' && (
                        <div className="flex gap-2">
                          <button onClick={()=>setChecks(prev=>({...prev,[item.code]:true}))} className={`toggle-btn px-4 py-2 rounded-xl text-sm font-medium transition ${checks[item.code]===true?'bg-red-500 text-white':'bg-gray-100 text-gray-500'}`}>ã¯ã„</button>
                          <button onClick={()=>setChecks(prev=>({...prev,[item.code]:false}))} className={`toggle-btn px-4 py-2 rounded-xl text-sm font-medium transition ${checks[item.code]===false?'bg-green-500 text-white':'bg-gray-100 text-gray-500'}`}>ã„ã„ãˆ</button>
                        </div>
                      )}
                      {item.inputType === 'body' && !patientMode && (
                        <div className="flex items-center gap-2">
                          <span className="text-xs text-gray-400">{isKaup ? 'ã‚«ã‚¦ãƒ—' : 'ãƒ­ãƒ¼ãƒ¬ãƒ«'}</span>
                          <span className={`px-3 py-2 rounded-xl text-sm font-medium ${bodyStatus==='normal'?'bg-green-100 text-green-700':bodyStatus==='underweight'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}`}>
                            {idx ? (bodyStatus==='normal'?'æ­£å¸¸':bodyStatus==='underweight'?'ã‚„ã›':'è‚¥æº€') : 'æœªç®—å‡º'}
                          </span>
                        </div>
                      )}
                      {item.inputType === 'body' && patientMode && (
                        <div className="flex flex-col gap-2 items-end">
                          <div className="flex gap-2">
                            <button onClick={()=>setChecks(prev=>({...prev,C13_patient:'yes'}))} className={`toggle-btn px-3 py-2 rounded-xl text-sm font-medium transition ${checks.C13_patient==='yes'?'bg-red-500 text-white':'bg-gray-100 text-gray-500'}`}>ã¯ã„</button>
                            <button onClick={()=>setChecks(prev=>({...prev,C13_patient:'no'}))} className={`toggle-btn px-3 py-2 rounded-xl text-sm font-medium transition ${checks.C13_patient==='no'?'bg-green-500 text-white':'bg-gray-100 text-gray-500'}`}>ã„ã„ãˆ</button>
                            <button onClick={()=>setChecks(prev=>({...prev,C13_patient:'unknown'}))} className={`toggle-btn px-3 py-2 rounded-xl text-sm font-medium transition ${checks.C13_patient==='unknown'?'bg-blue-500 text-white':'bg-gray-100 text-gray-500'}`}>ã‚ã‹ã‚‰ãªã„</button>
                          </div>
                          {checks.C13_patient==='unknown' && (
                            <span className="text-xs text-blue-600 font-medium">â†’ åŒ»é™¢ã§æ¸¬å®šã—ã¾ã™</span>
                          )}
                        </div>
                      )}
                    </div>
                    {item.inputType === 'habits' && checks[item.code] === true && (
                      <div className="mt-3 flex flex-wrap gap-2">
                        {HABITS_LIST.map(h=>(
                          <button key={h} onClick={()=>toggleHabit(h)} className={`px-3 py-2 rounded-lg text-xs font-medium transition ${(checks.C11||[]).includes(h)?'bg-orange-500 text-white':'bg-gray-100 text-gray-600'}`}>{h}</button>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          );
        })}

        {!patientMode && (
          <div className="mb-4">
            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-1">æ¤œæŸ»å€¤</h3>
            <div className="bg-white rounded-2xl card-shadow p-4 space-y-3">
              {isKaup ? (
                <div>
                  <label className="text-xs text-gray-500 mb-1 block">ã‚«ã‚¦ãƒ—æŒ‡æ•°ï¼ˆ6æ­³æœªæº€ï¼‰</label>
                  <div className={`px-3 py-3 rounded-xl text-base font-medium ${idx ? (bodyStatus==='normal'?'bg-green-50 text-green-700':bodyStatus==='underweight'?'bg-yellow-50 text-yellow-700':'bg-red-50 text-red-700') : 'bg-gray-50 text-gray-400'}`}>
                    {idx ? `${idx}${bodyStatus==='normal'?' ï¼ˆæ­£å¸¸ï¼‰':bodyStatus==='underweight'?' ï¼ˆã‚„ã›å‚¾å‘ï¼‰':' ï¼ˆè‚¥æº€å‚¾å‘ï¼‰'}` : 'ä½“é‡ãƒ»èº«é•·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'}
                  </div>
                </div>
              ) : (
                <div>
                  <label className="text-xs text-gray-500 mb-1 block">ãƒ­ãƒ¼ãƒ¬ãƒ«æŒ‡æ•°ï¼ˆ6æ­³ä»¥ä¸Šï¼‰</label>
                  <div className={`px-3 py-3 rounded-xl text-base font-medium ${idx ? (bodyStatus==='normal'?'bg-green-50 text-green-700':bodyStatus==='underweight'?'bg-yellow-50 text-yellow-700':'bg-red-50 text-red-700') : 'bg-gray-50 text-gray-400'}`}>
                    {idx ? `${idx}${bodyStatus==='normal'?' ï¼ˆæ­£å¸¸ï¼‰':bodyStatus==='underweight'?' ï¼ˆã‚„ã›å‚¾å‘ï¼‰':' ï¼ˆè‚¥æº€å‚¾å‘ï¼‰'}` : 'ä½“é‡ãƒ»èº«é•·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'}
                  </div>
                </div>
              )}
              <div className="flex gap-3">
                <div className="flex-1">
                  <label className="text-xs text-gray-500 mb-1 block">å£å”‡é–‰é–åŠ› (N)</label>
                  <input type="number" step="0.1" value={lipForce} onChange={e=>setLipForce(e.target.value)} className="w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl text-base" placeholder="N"/>
                </div>
                <div className="flex-1">
                  <label className="text-xs text-gray-500 mb-1 block">èˆŒåœ§ (kPa)</label>
                  <input type="number" step="0.1" value={tonguePressure} onChange={e=>setTonguePressure(e.target.value)} className="w-full px-3 py-3 bg-gray-50 border border-gray-200 rounded-xl text-base" placeholder="kPa"/>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// --- Management Plan ---
function LongPressButton({ onAction, className, children, label }) {
  const [progress, setProgress] = useState(0);
  const timerRef = useRef(null);
  const startRef = useRef(null);
  const DURATION = 2000;
  const start = () => {
    startRef.current = Date.now();
    const animate = () => {
      const elapsed = Date.now() - startRef.current;
      const p = Math.min(elapsed / DURATION, 1);
      setProgress(p);
      if (p >= 1) { onAction(); setProgress(0); return; }
      timerRef.current = requestAnimationFrame(animate);
    };
    timerRef.current = requestAnimationFrame(animate);
  };
  const end = () => {
    if (timerRef.current) { cancelAnimationFrame(timerRef.current); timerRef.current = null; }
    setProgress(0);
  };
  return (
    <button onTouchStart={start} onTouchEnd={end} onTouchCancel={end}
      onMouseDown={start} onMouseUp={end} onMouseLeave={end}
      className={`relative overflow-hidden select-none ${className}`}
      style={{WebkitUserSelect:'none',userSelect:'none'}}>
      {progress > 0 && <div className="absolute inset-0 bg-white opacity-30" style={{width:`${progress*100}%`,transition:'none'}}/>}
      <span className="relative z-10">{progress > 0 ? `${Math.round(progress*100)}%...` : (label || children)}</span>
    </button>
  );
}

function ManagementPlan({ patient, assessment, onSave, onBack, onPrint }) {
  const [plans, setPlans] = useState(() => {
    const initial = {};
    Object.entries(assessment.checks).forEach(([code, val]) => {
      const isChecked = code === 'C11' ? (val && val.length > 0) : code === 'C13' ? (val === 'underweight' || val === 'overweight') : val === true;
      if (isChecked && PLAN_TEMPLATES[code]) {
        initial[code] = assessment.plans?.[code] || { ...PLAN_TEMPLATES[code] };
      }
    });
    return initial;
  });
  const [overallPlan, setOverallPlan] = useState(assessment.overallPlan || '1. åŸå› å› å­ã®é™¤å»\n2. å£è…”æ©Ÿèƒ½è¨“ç·´ï¼ˆMFTï¼‰\n3. å’¬åˆèª˜å°\n4. ã‚«ãƒªã‚¨ã‚¹äºˆé˜²ç®¡ç†\n5. 3ã‹æœˆæ¯å†è©•ä¾¡');
  const [notes, setNotes] = useState(assessment.notes || '');

  const updatePlan = (code, field, value) => {
    setPlans(prev => ({...prev, [code]: {...prev[code], [field]: value}}));
  };

  const handleSave = () => {
    onSave({ ...assessment, plans, overallPlan, notes });
  };

  const checkedCodes = Object.keys(plans);

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title="ç®¡ç†è¨ˆç”»æ›¸" onBack={onBack} rightAction={
        <div className="flex gap-2">
          <button onClick={handleSave} className="toggle-btn bg-primary-600 text-white px-4 py-2 rounded-xl font-medium text-sm">ä¿å­˜</button>
          <button onClick={()=>{handleSave();onPrint();}} className="toggle-btn bg-dental-600 text-white px-4 py-2 rounded-xl font-medium text-sm">PDFå‡ºåŠ›</button>
        </div>
      }/>
      <div className="p-4 max-w-2xl mx-auto">
        <div className="bg-red-50 rounded-xl p-3 mb-4 text-sm text-red-700">
          è©²å½“é …ç›®: <span className="font-bold">{checkedCodes.length}é …ç›®</span>ï¼ˆ{checkedCodes.join(', ')}ï¼‰
        </div>

        {checkedCodes.length === 0 ? (
          <div className="bg-white rounded-2xl card-shadow p-8 text-center text-gray-400">
            <p>è©²å½“ã™ã‚‹è©•ä¾¡é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        ) : checkedCodes.map(code => {
          const item = CHECK_ITEMS.find(i=>i.code===code);
          const plan = plans[code];
          return (
            <div key={code} className="bg-white rounded-2xl card-shadow mb-4 overflow-hidden">
              <div className="bg-primary-600 text-white px-4 py-2 text-sm font-bold">
                {code} {item?.label}
              </div>
              <div className="p-4 space-y-3">
                <div>
                  <label className="text-xs font-medium text-gray-500 block mb-1">å•é¡Œç‚¹</label>
                  <textarea value={plan.problem} onChange={e=>updatePlan(code,'problem',e.target.value)}
                    className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={2}/>
                </div>
                {plan.shortTerm !== undefined ? (
                  <>
                    <div>
                      <label className="text-xs font-medium text-gray-500 block mb-1">çŸ­æœŸè¨ˆç”»</label>
                      <textarea value={plan.shortTerm} onChange={e=>updatePlan(code,'shortTerm',e.target.value)}
                        className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={2}/>
                    </div>
                    <div>
                      <label className="text-xs font-medium text-gray-500 block mb-1">ä¸­é•·æœŸè¨ˆç”»</label>
                      <textarea value={plan.longTerm} onChange={e=>updatePlan(code,'longTerm',e.target.value)}
                        className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={2}/>
                    </div>
                  </>
                ) : (
                  <div>
                    <label className="text-xs font-medium text-gray-500 block mb-1">ç®¡ç†è¨ˆç”»</label>
                    <textarea value={plan.plan} onChange={e=>updatePlan(code,'plan',e.target.value)}
                      className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={3}/>
                  </div>
                )}
              </div>
            </div>
          );
        })}

        <div className="bg-white rounded-2xl card-shadow mb-4 overflow-hidden">
          <div className="bg-gray-700 text-white px-4 py-2 text-sm font-bold">C-17 ç·åˆç®¡ç†è¨ˆç”»</div>
          <div className="p-4">
            <textarea value={overallPlan} onChange={e=>setOverallPlan(e.target.value)}
              className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={6}/>
          </div>
        </div>

        <div className="bg-white rounded-2xl card-shadow mb-4 p-4">
          <label className="text-xs font-medium text-gray-500 block mb-1">è¿½åŠ æ‰€è¦‹ãƒ»ãƒ¡ãƒ¢</label>
          <textarea value={notes} onChange={e=>setNotes(e.target.value)}
            className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm resize-none" rows={3} placeholder="è‡ªç”±è¨˜è¼‰..."/>
        </div>
      </div>
    </div>
  );
}

// --- Print View ---
function PrintView({ patient, assessment, onClose }) {
  const age = calcAge(patient.birthDate);
  const isKaup = age !== null && age < 6;
  const idx = isKaup ? calcKaup(parseFloat(patient.weight), parseFloat(patient.height)) : calcRohrer(parseFloat(patient.weight), parseFloat(patient.height));
  const plans = assessment.plans || {};
  const checkedCodes = Object.keys(plans);

  return (
    <div>
      <div className="no-print bg-white border-b px-4 py-3 flex items-center justify-between sticky top-0 z-50">
        <button onClick={onClose} className="text-primary-600 font-medium">â† æˆ»ã‚‹</button>
        <LongPressButton onAction={()=>window.print()} className="bg-dental-600 text-white px-6 py-2 rounded-xl font-medium text-sm" label="PDFä¿å­˜ / å°åˆ·"/>
      </div>

      {/* Page 1: ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ */}
      <div className="print-page max-w-3xl mx-auto p-6 bg-white" style={{minHeight:'auto'}}>
        <h1 style={{fontSize:'18px',fontWeight:'bold',textAlign:'center',marginBottom:'4px'}}>å£è…”æ©Ÿèƒ½è©•ä¾¡ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ</h1>
        <div style={{textAlign:'center',fontSize:'12px',color:'#666',marginBottom:'16px'}}>è©•ä¾¡æ—¥: {formatDate(assessment.date)}</div>

        <table style={{width:'100%',borderCollapse:'collapse',fontSize:'13px',marginBottom:'12px'}}>
          <tbody>
            <tr><td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5',width:'80px'}}>æ‚£è€…å</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{patient.name}</td>
                <td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5',width:'80px'}}>å¹´é½¢</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{age}æ­³</td></tr>
            <tr><td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>ä½“é‡</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{patient.weight} kg</td>
                <td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>èº«é•·</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{patient.height} cm</td></tr>
            <tr><td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>{isKaup?'ã‚«ã‚¦ãƒ—æŒ‡æ•°':'ãƒ­ãƒ¼ãƒ¬ãƒ«æŒ‡æ•°'}</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{idx || '-'}</td>
                <td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>å£å”‡é–‰é–åŠ›</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{assessment.lipForce ? assessment.lipForce+' N' : '-'}</td></tr>
            <tr><td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>èˆŒåœ§</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{assessment.tonguePressure ? assessment.tonguePressure+' kPa' : '-'}</td>
                <td style={{padding:'4px 8px',border:'1px solid #ddd',background:'#f5f5f5'}}>æ‹…å½“åŒ»</td><td style={{padding:'4px 8px',border:'1px solid #ddd'}}>{patient.doctor || '-'}</td></tr>
          </tbody>
        </table>

        <table style={{width:'100%',borderCollapse:'collapse',fontSize:'12px'}}>
          <thead>
            <tr style={{background:'#2563eb',color:'white'}}>
              <th style={{padding:'6px',border:'1px solid #2563eb',width:'50px'}}>ã‚³ãƒ¼ãƒ‰</th>
              <th style={{padding:'6px',border:'1px solid #2563eb',textAlign:'left'}}>è©•ä¾¡é …ç›®</th>
              <th style={{padding:'6px',border:'1px solid #2563eb',width:'60px'}}>çµæœ</th>
            </tr>
          </thead>
          <tbody>
            {CHECK_ITEMS.map((item,i) => {
              const val = assessment.checks[item.code];
              let result = '-';
              let isPositive = false;
              if (item.code === 'C11') { isPositive = val && val.length > 0; result = isPositive ? val.join(', ') : 'è©²å½“ãªã—'; }
              else if (item.code === 'C13') { isPositive = val==='underweight'||val==='overweight'; result = val==='normal'?'æ­£å¸¸':val==='underweight'?'ã‚„ã›':'è‚¥æº€'; }
              else { isPositive = val === true; result = val === true ? 'è©²å½“' : 'éè©²å½“'; }
              return (
                <tr key={item.code} style={{background: isPositive ? '#fef2f2' : i%2===0 ? '#fff' : '#f9fafb'}}>
                  <td style={{padding:'4px 6px',border:'1px solid #ddd',textAlign:'center',fontWeight:'bold'}}>{item.code}</td>
                  <td style={{padding:'4px 6px',border:'1px solid #ddd'}}>{item.label}</td>
                  <td style={{padding:'4px 6px',border:'1px solid #ddd',textAlign:'center',color:isPositive?'#dc2626':'#666',fontWeight:isPositive?'bold':'normal'}}>{item.code==='C11' && isPositive ? 'è©²å½“' : result}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {assessment.checks.C11 && assessment.checks.C11.length > 0 && (
          <div style={{fontSize:'11px',marginTop:'4px',color:'#666'}}>C11 å£è…”ç¿’ç™–: {assessment.checks.C11.join('ã€')}</div>
        )}
      </div>

      {/* Page 2: ç®¡ç†è¨ˆç”»æ›¸ */}
      <div className="print-page max-w-3xl mx-auto p-6 bg-white mt-4">
        <h1 style={{fontSize:'18px',fontWeight:'bold',textAlign:'center',marginBottom:'4px',color:'#1d4ed8'}}>å£è…”æ©Ÿèƒ½ç™ºé”ä¸å…¨ç—‡ ç®¡ç†è¨ˆç”»æ›¸</h1>
        <div style={{textAlign:'center',fontSize:'12px',color:'#666',marginBottom:'16px'}}>
          æ‚£è€…å: {patient.name}ã€€ã€€ä½œæˆæ—¥: {formatDate(assessment.date)}ã€€ã€€æ‹…å½“åŒ»: {patient.doctor || ''}
        </div>

        {checkedCodes.length > 0 && (
          <table style={{width:'100%',borderCollapse:'collapse',fontSize:'12px',marginBottom:'16px'}}>
            <thead>
              <tr style={{background:'#1d4ed8',color:'white'}}>
                <th style={{padding:'6px',border:'1px solid #1d4ed8',width:'100px'}}>é …ç›®</th>
                <th style={{padding:'6px',border:'1px solid #1d4ed8'}}>å•é¡Œç‚¹</th>
                <th style={{padding:'6px',border:'1px solid #1d4ed8'}}>çŸ­æœŸè¨ˆç”»</th>
                <th style={{padding:'6px',border:'1px solid #1d4ed8'}}>ä¸­é•·æœŸè¨ˆç”»</th>
              </tr>
            </thead>
            <tbody>
              {checkedCodes.map((code,i) => {
                const item = CHECK_ITEMS.find(it=>it.code===code);
                const plan = plans[code];
                const is3stage = plan.shortTerm !== undefined;
                return (
                  <tr key={code} style={{background:i%2===0?'#fff':'#f9fafb'}}>
                    <td style={{padding:'6px',border:'1px solid #ddd',fontWeight:'bold',verticalAlign:'top'}}>
                      <div>{code}</div><div style={{fontSize:'10px',fontWeight:'normal',color:'#666'}}>{item?.label}</div>
                    </td>
                    <td style={{padding:'6px',border:'1px solid #ddd',verticalAlign:'top'}}>{plan.problem}</td>
                    {is3stage ? (
                      <>
                        <td style={{padding:'6px',border:'1px solid #ddd',verticalAlign:'top'}}>{plan.shortTerm}</td>
                        <td style={{padding:'6px',border:'1px solid #ddd',verticalAlign:'top'}}>{plan.longTerm}</td>
                      </>
                    ) : (
                      <td colSpan={2} style={{padding:'6px',border:'1px solid #ddd',verticalAlign:'top'}}>{plan.plan}</td>
                    )}
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}

        <div style={{border:'2px solid #374151',borderRadius:'8px',padding:'12px',marginBottom:'12px'}}>
          <h3 style={{fontSize:'13px',fontWeight:'bold',marginBottom:'8px',color:'#374151'}}>C-17 ç·åˆç®¡ç†è¨ˆç”»</h3>
          <div style={{fontSize:'12px',whiteSpace:'pre-line'}}>{assessment.overallPlan || ''}</div>
        </div>

        {assessment.notes && (
          <div style={{border:'1px solid #ddd',borderRadius:'8px',padding:'12px'}}>
            <h3 style={{fontSize:'13px',fontWeight:'bold',marginBottom:'4px',color:'#666'}}>è¿½åŠ æ‰€è¦‹</h3>
            <div style={{fontSize:'12px',whiteSpace:'pre-line'}}>{assessment.notes}</div>
          </div>
        )}

        <div style={{marginTop:'24px',fontSize:'11px',color:'#999',textAlign:'right'}}>
          æ¬¡å›è©•ä¾¡äºˆå®š: ï¼¿ï¼¿ï¼¿ï¼¿å¹´ï¼¿ï¼¿æœˆï¼¿ï¼¿æ—¥
        </div>
      </div>
    </div>
  );
}

// --- Patient Detail ---
function PatientDetail({ patient, assessments, onBack, onEdit, onNewAssessment, onSelectAssessment, onDeleteAssessment }) {
  const [deleteHold, setDeleteHold] = useState(null);
  const [deleteProgress, setDeleteProgress] = useState(0);
  const deleteTimerRef = useRef(null);
  const deleteStartRef = useRef(null);
  const DELETE_DURATION = 2000;
  const handleDeleteStart = (aId) => {
    setDeleteHold(aId);
    deleteStartRef.current = Date.now();
    const animate = () => {
      const elapsed = Date.now() - deleteStartRef.current;
      const progress = Math.min(elapsed / DELETE_DURATION, 1);
      setDeleteProgress(progress);
      if (progress >= 1) { onDeleteAssessment(aId); setDeleteHold(null); setDeleteProgress(0); return; }
      deleteTimerRef.current = requestAnimationFrame(animate);
    };
    deleteTimerRef.current = requestAnimationFrame(animate);
  };
  const handleDeleteEnd = () => {
    if (deleteTimerRef.current) { cancelAnimationFrame(deleteTimerRef.current); deleteTimerRef.current = null; }
    setDeleteHold(null); setDeleteProgress(0);
  };
  const age = calcAge(patient.birthDate);
  const patientAssessments = assessments.filter(a => a.patientId === patient.id).sort((a,b) => new Date(b.date) - new Date(a.date));

  return (
    <div className="min-h-screen bg-gray-50">
      <Header title="æ‚£è€…è©³ç´°" onBack={onBack} rightAction={
        <button onClick={onEdit} className="toggle-btn text-primary-600 font-medium text-sm">ç·¨é›†</button>
      }/>
      <div className="p-4 max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl card-shadow p-4 mb-4">
          <div className="flex justify-between items-start">
            <div>
              <div className="text-xl font-bold text-gray-800">{patient.name}</div>
              <div className="text-sm text-gray-500 mt-1">{age !== null ? `${age}æ­³` : ''} {patient.sex==='M'?'ç”·å…':patient.sex==='F'?'å¥³å…':''}</div>
            </div>
            {patient.patientId && <span className="text-xs text-gray-400">ID: {patient.patientId}</span>}
          </div>
          <div className="grid grid-cols-2 gap-2 mt-3 text-sm">
            <div className="text-gray-500">ä½“é‡: <span className="text-gray-800">{patient.weight || '-'} kg</span></div>
            <div className="text-gray-500">èº«é•·: <span className="text-gray-800">{patient.height || '-'} cm</span></div>
            <div className="text-gray-500">ä¿è­·è€…: <span className="text-gray-800">{patient.guardianName || '-'}</span></div>
            <div className="text-gray-500">æ‹…å½“åŒ»: <span className="text-gray-800">{patient.doctor || '-'}</span></div>
          </div>
        </div>

        <button onClick={onNewAssessment} className="w-full bg-primary-600 text-white py-4 rounded-2xl font-bold text-base mb-4 active:bg-primary-700 transition card-shadow">
          ï¼‹ æ–°ã—ã„è©•ä¾¡ã‚’é–‹å§‹
        </button>

        <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 px-1">è©•ä¾¡å±¥æ­´</h3>
        {patientAssessments.length === 0 ? (
          <div className="bg-white rounded-2xl card-shadow p-8 text-center text-gray-400 text-sm">ã¾ã è©•ä¾¡è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        ) : patientAssessments.map(a => {
          const checkedCount = Object.entries(a.checks).filter(([k,v])=>{
            if(k==='C11') return v&&v.length>0;
            if(k==='C13') return v==='underweight'||v==='overweight';
            return v===true;
          }).length;
          return (
            <div key={a.id} className="flex items-center gap-2 mb-3">
              <button onClick={()=>onSelectAssessment(a)} className="flex-1 text-left bg-white rounded-2xl p-4 card-shadow active:bg-gray-50 transition">
                <div className="flex justify-between items-center">
                  <div className="text-sm font-medium text-gray-800">{formatDate(a.date)}</div>
                  <span className="bg-red-50 text-red-600 text-xs font-bold px-2 py-1 rounded-lg">è©²å½“ {checkedCount}é …ç›®</span>
                </div>
              </button>
              <button
                onTouchStart={()=>handleDeleteStart(a.id)} onTouchEnd={handleDeleteEnd} onTouchCancel={handleDeleteEnd}
                onMouseDown={()=>handleDeleteStart(a.id)} onMouseUp={handleDeleteEnd} onMouseLeave={handleDeleteEnd}
                className="relative overflow-hidden toggle-btn px-3 py-3 rounded-xl text-xs font-medium bg-red-50 text-red-500 border border-red-200 select-none shrink-0"
                style={{WebkitUserSelect:'none',userSelect:'none'}}
              >
                {deleteHold === a.id && deleteProgress > 0 && (
                  <div className="absolute inset-0 bg-red-500 opacity-30" style={{width:`${deleteProgress*100}%`,transition:'none'}}/>
                )}
                <span className="relative z-10">{deleteHold === a.id && deleteProgress > 0 ? 'å‰Šé™¤ä¸­...' : 'å‰Šé™¤'}</span>
              </button>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ==================== APP ====================
function App() {
  const [pin, setPin] = useState(null);
  const [data, setData] = useState({ patients: [], assessments: [] });
  const [ready, setReady] = useState(false);
  const [page, setPage] = useState('list');
  const [currentPatient, setCurrentPatient] = useState(null);
  const [currentAssessment, setCurrentAssessment] = useState(null);
  const [editingPatient, setEditingPatient] = useState(null);
  const firestoreListenersRef = useRef([]);

  const handleAuth = async (enteredPin) => {
    setPin(enteredPin);
    // migrate legacy unencrypted data if exists
    const legacy = getLegacyData();
    let initialData = { patients: [], assessments: [] };

    if (legacy && (legacy.patients.length > 0 || legacy.assessments.length > 0)) {
      initialData = legacy;
      await encryptData(legacy, enteredPin);
      localStorage.removeItem('oralFuncData');
    } else {
      try { initialData = await decryptData(enteredPin); } catch { initialData = { patients: [], assessments: [] }; }
    }

    // Try to load from Firestore first, fall back to local encrypted data
    if (firebaseReady && db) {
      const firestoreData = await loadDataFromFirestore();
      if (firestoreData && (firestoreData.patients.length > 0 || firestoreData.assessments.length > 0)) {
        initialData = firestoreData;
      }
    }

    setData(initialData);
    setReady(true);
  };

  // Setup Firestore real-time listeners
  useEffect(() => {
    if (!pin || !ready || !firebaseReady || !db) return;

    // Cleanup previous listeners
    firestoreListenersRef.current.forEach(unsubscribe => unsubscribe());
    firestoreListenersRef.current = [];

    // Listen to patients collection
    const unsubPatients = db.collection('patients').onSnapshot(snapshot => {
      const patients = [];
      snapshot.forEach(doc => patients.push(doc.data()));
      setData(prev => ({ ...prev, patients }));
    }, error => {
      console.warn('Error listening to patients:', error);
    });

    // Listen to assessments collection
    const unsubAssessments = db.collection('assessments').onSnapshot(snapshot => {
      const assessments = [];
      snapshot.forEach(doc => assessments.push(doc.data()));
      setData(prev => ({ ...prev, assessments }));
    }, error => {
      console.warn('Error listening to assessments:', error);
    });

    firestoreListenersRef.current = [unsubPatients, unsubAssessments];

    return () => {
      firestoreListenersRef.current.forEach(unsubscribe => unsubscribe());
    };
  }, [pin, ready]);

  // Save encrypted data to localStorage whenever data changes (offline backup)
  useEffect(() => { if (pin && ready) { encryptData(data, pin); } }, [data, pin, ready]);

  if (!pin) return <PinScreen onAuth={handleAuth}/>;
  if (!ready) return <div className="min-h-screen flex items-center justify-center"><p className="text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</p></div>;

  const savePatient = (p) => {
    setData(prev => {
      const exists = prev.patients.find(x => x.id === p.id);
      if (exists) {
        return { ...prev, patients: prev.patients.map(x => x.id === p.id ? p : x) };
      }
      return { ...prev, patients: [...prev.patients, p] };
    });
    // Sync to Firestore
    savePatientToFirestore(p);
    setCurrentPatient(p);
    setPage('detail');
  };

  const saveAssessment = (a) => {
    setData(prev => {
      const exists = prev.assessments.find(x => x.id === a.id);
      if (exists) {
        return { ...prev, assessments: prev.assessments.map(x => x.id === a.id ? a : x) };
      }
      return { ...prev, assessments: [...prev.assessments, a] };
    });
    // Sync to Firestore
    saveAssessmentToFirestore(a);
    setCurrentAssessment(a);
    setPage('plan');
  };

  const savePlan = (a) => {
    setData(prev => ({
      ...prev,
      assessments: prev.assessments.map(x => x.id === a.id ? a : x)
    }));
    // Sync to Firestore
    saveAssessmentToFirestore(a);
    setCurrentAssessment(a);
  };

  const deleteAssessment = (aId) => {
    setData(prev => ({
      ...prev,
      assessments: prev.assessments.filter(a => a.id !== aId)
    }));
    // Delete from Firestore
    try { db.collection('assessments').doc(aId).delete(); } catch(e) { console.log('Firestore delete error', e); }
  };

  const deletePatient = (id) => {
    if(!confirm('ã“ã®æ‚£è€…ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    setData(prev => ({
      patients: prev.patients.filter(p => p.id !== id),
      assessments: prev.assessments.filter(a => a.patientId !== id)
    }));
    // Delete from Firestore
    deletePatientFromFirestore(id);
    setPage('list');
  };

  if (page === 'print' && currentPatient && currentAssessment) {
    return <PrintView patient={currentPatient} assessment={currentAssessment} onClose={()=>setPage('plan')}/>;
  }

  if (page === 'list') {
    return <PatientList patients={data.patients} assessments={data.assessments}
      onSelect={p=>{setCurrentPatient(p);setPage('detail');}}
      onAdd={()=>{setEditingPatient(null);setPage('form');}}/>;
  }

  if (page === 'form') {
    return <PatientForm patient={editingPatient} onSave={savePatient} onCancel={()=>{
      if(currentPatient) setPage('detail'); else setPage('list');
    }}/>;
  }

  if (page === 'detail' && currentPatient) {
    return <PatientDetail patient={currentPatient} assessments={data.assessments}
      onBack={()=>setPage('list')}
      onEdit={()=>{setEditingPatient(currentPatient);setPage('form');}}
      onNewAssessment={()=>{setCurrentAssessment(null);setPage('assessment');}}
      onSelectAssessment={a=>{setCurrentAssessment(a);setPage('plan');}}
      onDeleteAssessment={deleteAssessment}/>;
  }

  if (page === 'assessment' && currentPatient) {
    return <AssessmentForm patient={currentPatient} existingAssessment={currentAssessment}
      onSave={saveAssessment}
      onCancel={()=>setPage('detail')}/>;
  }

  if (page === 'plan' && currentPatient && currentAssessment) {
    return <ManagementPlan patient={currentPatient} assessment={currentAssessment}
      onSave={savePlan} onBack={()=>setPage('detail')} onPrint={()=>setPage('print')}/>;
  }

  return <PatientList patients={data.patients} assessments={data.assessments}
    onSelect={p=>{setCurrentPatient(p);setPage('detail');}}
    onAdd={()=>{setEditingPatient(null);setPage('form');}}/>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
